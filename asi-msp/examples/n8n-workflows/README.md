# n8n Workflow Examples for MCP Security Server

This directory contains ready-to-use n8n workflow templates for security assessments using the MCP Security Server async scan API.

## Available Workflows

### 1. Async Security Scan - Polling Pattern
**File**: `async-security-scan-polling.json`

**Description**: Demonstrates the polling pattern for long-running scans. Starts a scan, polls status every 10 seconds, retrieves results when complete, and feeds to AI for analysis.

**Use Case**:
- Learning the async API pattern
- Debugging scan execution
- When webhooks are not available

**Flow**:
```
Manual Trigger
  ↓
Configure Target (nuclei_scan)
  ↓
Start Async Scan → Get job_id
  ↓
Wait 10 seconds
  ↓
Check Status → Is completed?
  ├─ YES → Get Results → AI Analysis → Final Report
  └─ NO → Loop back (max 60 retries = 10 minutes)
```

**Features**:
- ✅ Configurable target and tool
- ✅ Automatic retry logic with max timeout
- ✅ Error handling for failed scans
- ✅ AI-powered security analysis
- ✅ Structured final report output

**Configuration**:
- Edit "Set Target Config" node to change:
  - `target`: URL to scan (default: https://ginandjuice.shop)
  - `tool`: Security tool to use (default: nuclei_scan)
  - `severity`: Scan severity filter (default: high,critical)
- Adjust "Wait 10 Seconds" node for different polling intervals
- Modify `max_retries` in "Save Job Info" for longer timeouts

---

### 2. Async Security Scan - Webhook Pattern
**File**: `async-security-scan-webhook.json`

**Description**: Production-ready webhook pattern. Starts scan with webhook callback URL, then waits for MCP server to POST results automatically when complete.

**Use Case**:
- Production deployments
- Scheduled security monitoring
- When you want instant notifications

**Flow**:
```
[Part 1: Start Workflow]
Manual Trigger
  ↓
Configure Scan (with webhook URL)
  ↓
Start Scan → Returns confirmation
  ↓
Workflow waits...

[Part 2: Webhook Receives Results]
MCP Server POSTs results
  ↓
Webhook Receives → Is successful?
  ├─ YES → Extract Results → AI Analysis → Security Report
  └─ NO → Handle Error
```

**Features**:
- ✅ No polling needed (instant notification)
- ✅ More efficient (less API calls)
- ✅ Better for very long scans
- ✅ Automatic webhook URL generation
- ✅ Professional security assessment output

**Configuration**:
- Edit "Configure Scan" node to change target/tool
- Webhook URL is automatically generated by n8n
- The MCP server will POST to: `https://your-n8n.com/webhook/security-scan-complete`

**Important**: Ensure your n8n instance is accessible from the MCP Security Server container. For local testing, you may need to:
1. Use ngrok or similar to expose n8n
2. Or configure Docker networking to allow container → host communication

---

### 3. Comprehensive Security Assessment - Multi-Tool
**File**: `comprehensive-security-assessment.json`

**Description**: Runs multiple security tools concurrently, aggregates results, and provides integrated AI analysis across all findings.

**Use Case**:
- Complete security audits
- Thorough penetration testing
- Executive security reports

**Flow**:
```
Manual Trigger
  ↓
Set Target
  ├─ Start httpx (tech stack)
  ├─ Start wafw00f (WAF detection)
  ├─ Start nuclei (vulnerabilities)
  └─ Start gobuster (directories)
  ↓
Merge Job IDs
  ↓
Wait 30 seconds (adjust based on needs)
  ↓
Get All Completed Scans
  ↓
Split and Fetch Each Result
  ↓
Aggregate All Results
  ↓
AI Comprehensive Analysis
  ↓
Final Assessment Report
```

**Features**:
- ✅ 4 concurrent scans (httpx, wafw00f, nuclei, gobuster)
- ✅ Parallel execution for speed
- ✅ Integrated analysis across tools
- ✅ Executive-level AI assessment
- ✅ Complete security posture report

**Configuration**:
- Edit "Set Target" node to change target URL
- Add/remove scan nodes to customize tool selection
- Adjust "Wait 30 Seconds" based on your target's complexity
- Modify AI prompt in "AI Comprehensive Analysis" for custom output

**Scan Duration Estimates**:
- httpx: < 1 second
- wafw00f: 1-2 seconds
- gobuster: 60-120 seconds (depends on wordlist)
- nuclei (high/critical): 60-120 seconds

**Total Time**: ~2-3 minutes for typical web application

---

## Installation

### Step 1: Import Workflows

1. Open your n8n instance
2. Click "Workflows" → "Add Workflow" → "Import from File"
3. Select one of the JSON files from this directory
4. Click "Import"

### Step 2: Configure Credentials

If using AI Analysis nodes, configure Anthropic credentials:

1. Go to "Credentials" in n8n
2. Add "Anthropic API" credentials
3. Enter your API key
4. Link credentials to "AI Security Analysis" nodes

### Step 3: Update MCP Server URL

If your MCP Security Server is not at `http://mcp-security-server:3000`, update all HTTP Request nodes:

1. Search for nodes containing "mcp-security-server:3000"
2. Replace with your actual URL (e.g., `http://localhost:3000`)

### Step 4: Test Workflow

1. Click "Execute Workflow" (test run)
2. Monitor execution in real-time
3. Check results in the output panel

---

## Customization Guide

### Changing Target
**Node**: "Set Target" or "Set Target Config"
```json
{
  "target": "https://your-target.com"
}
```

### Changing Scan Tool
**Node**: Any "Start Scan" HTTP Request node
```json
{
  "tool": "nuclei_scan",     // Change to: gobuster_scan, nikto_scan, etc.
  "target": "...",
  "arguments": {...}
}
```

### Adding More Tools
Duplicate "Start Scan" HTTP Request node:
1. Right-click node → Duplicate
2. Change tool name in body parameters
3. Connect to merge/wait node

### Adjusting Scan Parameters

**For nuclei_scan**:
```json
{
  "arguments": {
    "severity": "info,low,medium,high,critical",  // All severities
    "templates": "/path/to/custom/templates"      // Custom templates
  }
}
```

**For gobuster_scan**:
```json
{
  "arguments": {
    "wordlist": "/usr/share/dirb/wordlists/big.txt",  // Larger wordlist
    "extensions": "php,html,js"                        // File extensions
  }
}
```

**For nmap_scan**:
```json
{
  "arguments": {
    "scan_type": "sS",      // SYN scan (faster)
    "ports": "1-65535"      // All ports
  }
}
```

See `docs/async-scan-api.md` for complete parameter reference.

### Changing Polling Interval
**Node**: "Wait 10 Seconds"

- Fast scans (< 30s): 5 second interval
- Medium scans (30s-2m): 10 second interval
- Slow scans (> 2m): 30 second interval

### Adjusting Timeout
**Node**: "Save Job Info"
```json
{
  "max_retries": 60  // 60 retries × 10s = 10 minute timeout
}
```

### Customizing AI Prompts
**Node**: "AI Security Analysis"

Edit the `text` parameter to customize AI output:
```
You are a [role] analyzing security scan results.

Provide:
1. [Custom section 1]
2. [Custom section 2]
...

Scan Data:
{{ $json.scan_summary }}
```

---

## Troubleshooting

### Issue 1: "Cannot connect to mcp-security-server:3000"

**Solution**:
- Check Docker network: `docker network ls`
- Verify container is running: `docker ps | grep mcp-security-server`
- If running locally, use `http://localhost:3000` instead
- For Docker Desktop: use `http://host.docker.internal:3000`

### Issue 2: Webhook Not Receiving Results

**Symptoms**: Workflow starts scan but never receives webhook callback

**Solutions**:
1. Check webhook URL is accessible from MCP container:
   ```bash
   docker exec mcp-security-server curl -X POST https://your-n8n.com/webhook/test
   ```

2. For local development, use ngrok:
   ```bash
   ngrok http 5678  # Assuming n8n on port 5678
   # Use ngrok URL in webhook configuration
   ```

3. Check MCP server logs for webhook errors:
   ```bash
   docker logs mcp-security-server | grep webhook
   ```

### Issue 3: Scan Times Out

**Symptoms**: Polling workflow hits max retries

**Solutions**:
1. Increase `max_retries` in "Save Job Info" node
2. Use webhook pattern instead (no timeout)
3. Reduce scan scope (e.g., only high/critical for nuclei)
4. Check scan is actually running:
   ```bash
   curl http://localhost:3000/scans/{job_id}/status
   ```

### Issue 4: AI Node Returns Error

**Symptoms**: "Missing credentials" or API errors

**Solutions**:
1. Verify Anthropic API credentials are configured
2. Check API key has sufficient quota
3. Reduce input size if payload too large
4. Check Anthropic API status: https://status.anthropic.com

### Issue 5: Results Not Showing

**Symptoms**: Workflow completes but output is empty

**Solutions**:
1. Check scan actually completed:
   ```bash
   curl http://localhost:3000/scans?status=completed
   ```

2. Verify result retrieval URL is correct
3. Check for errors in "Get Results" node
4. Review scan logs:
   ```bash
   docker logs mcp-security-server --tail 100
   ```

---

## Performance Tips

### 1. Optimize Polling Interval
Don't poll too frequently:
- **Bad**: 1 second interval (unnecessary API calls)
- **Good**: 10-30 second interval (efficient)

### 2. Run Scans Concurrently
Start multiple scans at once (see comprehensive workflow):
```
Sequential: 120s + 120s + 120s = 360s (6 minutes)
Concurrent: max(120s, 120s, 120s) = 120s (2 minutes)
```

### 3. Use Webhooks for Long Scans
Polling is less efficient for scans > 5 minutes:
- **Polling**: 60 API calls (1 every 10s for 10 minutes)
- **Webhook**: 2 API calls (start + receive results)

### 4. Filter Scan Scope
Reduce scan time by limiting scope:
```json
// Nuclei - only high/critical (faster)
{"severity": "high,critical"}

// Gobuster - smaller wordlist (faster)
{"wordlist": "/usr/share/dirb/wordlists/small.txt"}

// Nmap - specific ports (faster)
{"ports": "80,443,8080,8443"}
```

---

## Security Considerations

### 1. Credential Management
- Store API keys in n8n credentials (encrypted)
- Never hardcode secrets in workflows
- Use environment variables for sensitive data

### 2. Target Authorization
- Only scan authorized targets
- Verify domain/IP is in MCP server whitelist
- Document authorization in workflow notes

### 3. Result Handling
- Be careful with result storage (may contain sensitive data)
- Implement access controls on workflow results
- Consider data retention policies

### 4. Webhook Security
- Use HTTPS webhooks in production
- Validate webhook payloads
- Consider implementing HMAC signatures

---

## Advanced Patterns

### Pattern 1: Scheduled Security Monitoring

Add a Schedule Trigger node:
```
Schedule Trigger (daily at 2 AM)
  ↓
[Rest of workflow]
  ↓
Email Report Node (if issues found)
```

### Pattern 2: Conditional Scans

Use IF nodes to run different scans based on initial reconnaissance:
```
Start httpx
  ↓
Get Results
  ↓
IF WordPress detected:
  ↓
  Start wpscan
ELSE IF PHP detected:
  ↓
  Start nikto
```

### Pattern 3: Result Storage

Add database nodes to store historical results:
```
Get Scan Results
  ↓
Format for Database
  ↓
Insert into PostgreSQL/MySQL
  ↓
Generate Trend Report
```

### Pattern 4: Multi-Target Scanning

Use Loop nodes to scan multiple targets:
```
Set Target List (array)
  ↓
Loop Over Targets
  ↓
  Start Scan for Each
  ↓
Aggregate All Results
```

---

## Example Use Cases

### Use Case 1: Continuous Security Testing
**Goal**: Scan production application daily, alert on new vulnerabilities

**Workflow**: Webhook pattern + Schedule trigger + Email notification

**Setup**:
1. Import webhook workflow
2. Add Schedule Trigger (daily)
3. Add IF node: if new vulnerabilities found
4. Add Email node: notify security team

### Use Case 2: Pre-Deployment Security Gate
**Goal**: Scan staging environment before production deployment

**Workflow**: Comprehensive assessment + conditional deployment

**Setup**:
1. Import comprehensive workflow
2. Trigger from CI/CD pipeline
3. Add IF node: if critical issues found → block deployment
4. Add Slack notification for results

### Use Case 3: Bug Bounty Reconnaissance
**Goal**: Quick security assessment of target for bug bounty

**Workflow**: Multi-tool concurrent scans

**Setup**:
1. Import comprehensive workflow
2. Add more recon tools (subfinder, theharvester)
3. Save results to notion/database
4. Generate report for manual review

---

## Support and Resources

### Documentation
- Full API docs: `../../docs/async-scan-api.md`
- n8n integration guide: `../../docs/n8n-async-workflow-guide.md`
- Main documentation: `../../ALL-ISSUES-RESOLVED.md`

### Quick Reference
- API quick ref: `../../docs/ASYNC-API-QUICKREF.md`

### Testing
```bash
# Test MCP server health
curl http://localhost:3000/health

# List available tools
curl -X POST http://localhost:3000/messages \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/list"}'

# Start test scan
curl -X POST http://localhost:3000/scans/start \
  -H "Content-Type: application/json" \
  -d '{"tool":"httpx_scan","target":"https://example.com","arguments":{}}'
```

### Getting Help
1. Check container logs: `docker logs mcp-security-server`
2. Review troubleshooting section above
3. Test with curl first to isolate n8n vs API issues
4. Check n8n workflow execution logs

---

## Contributing

Have a useful workflow pattern? Please share:

1. Export your workflow (without credentials)
2. Add clear documentation
3. Include example use case
4. Test with default MCP configuration

---

## Version History

**v1.0.0** (2026-01-14)
- Initial release
- 3 example workflows
- Polling, webhook, and multi-tool patterns
- Complete documentation

---

## License

These workflows are provided as examples for the MCP Security Server project. Modify and use freely for your security assessments.

**Remember**: Only scan systems you have explicit permission to test.

---

**Updated**: 2026-01-14
**Status**: Production Ready ✅
