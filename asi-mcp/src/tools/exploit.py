"""
Exploitation and credential testing tools.

Includes: hydra, hashcat, john, crackmapexec
"""

from typing import Dict, List, Any
import mcp.types as types

from ..logging_config import get_logger
from ..safety import get_validator
from .network import execute_command

logger = get_logger(__name__)


async def hydra_bruteforce(
    target: str,
    service: str = "ssh",
    username: str = "",
    username_list: str = "",
    password_list: str = "/usr/share/wordlists/rockyou.txt",
    port: int = 0
) -> Dict[str, Any]:
    """
    Password brute-forcing with hydra.

    Args:
        target: Target IP or hostname
        service: Service to attack (ssh, ftp, http, etc.)
        username: Single username
        username_list: Path to username list
        password_list: Path to password list
        port: Custom port

    Returns:
        Brute-force results
    """
    validator = get_validator()

    try:
        validator.validate_target(target)

        cmd = ["hydra"]

        if username:
            cmd.extend(["-l", username])
        elif username_list:
            cmd.extend(["-L", username_list])

        cmd.extend(["-P", password_list])

        if port:
            cmd.extend(["-s", str(port)])

        cmd.extend([target, service])

        validator.log_tool_execution(
            "hydra",
            target,
            {"service": service, "username": username}
        )

        result = await execute_command(cmd, timeout=900, tool_name="hydra")

        return {
            "tool": "hydra",
            "target": target,
            "service": service,
            "success": result["success"],
            "output": result["stdout"],
            "errors": result["stderr"],
            "duration_seconds": result["duration_seconds"]
        }

    except Exception as e:
        logger.error(f"Hydra error: {e}")
        return {
            "tool": "hydra",
            "target": target,
            "success": False,
            "error": str(e)
        }


async def hashcat_crack(
    hash_file: str,
    hash_type: int = 0,
    wordlist: str = "/usr/share/wordlists/rockyou.txt",
    rules: str = ""
) -> Dict[str, Any]:
    """
    Password hash cracking with hashcat.

    Args:
        hash_file: File containing hashes
        hash_type: Hash type (0=MD5, 1000=NTLM, 1800=SHA512, etc.)
        wordlist: Wordlist path
        rules: Rules file path

    Returns:
        Cracking results
    """
    try:
        cmd = [
            "hashcat",
            "-m", str(hash_type),
            "-a", "0",  # Dictionary attack
            hash_file,
            wordlist,
            "--show"
        ]

        if rules:
            cmd.extend(["-r", rules])

        result = await execute_command(cmd, timeout=1800, tool_name="hashcat")

        return {
            "tool": "hashcat",
            "hash_file": hash_file,
            "hash_type": hash_type,
            "success": result["success"],
            "output": result["stdout"],
            "errors": result["stderr"],
            "duration_seconds": result["duration_seconds"]
        }

    except Exception as e:
        logger.error(f"Hashcat error: {e}")
        return {
            "tool": "hashcat",
            "hash_file": hash_file,
            "success": False,
            "error": str(e)
        }


async def john_crack(
    hash_file: str,
    format: str = "",
    wordlist: str = "/usr/share/wordlists/rockyou.txt"
) -> Dict[str, Any]:
    """
    Password cracking with John the Ripper.

    Args:
        hash_file: File containing hashes
        format: Hash format (md5, sha256, nt, etc.)
        wordlist: Wordlist path

    Returns:
        Cracking results
    """
    try:
        cmd = ["john", hash_file]

        if format:
            cmd.extend(["--format", format])

        cmd.extend(["--wordlist", wordlist])

        result = await execute_command(cmd, timeout=1800, tool_name="john")

        return {
            "tool": "john",
            "hash_file": hash_file,
            "format": format,
            "success": result["success"],
            "output": result["stdout"],
            "errors": result["stderr"],
            "duration_seconds": result["duration_seconds"]
        }

    except Exception as e:
        logger.error(f"John error: {e}")
        return {
            "tool": "john",
            "hash_file": hash_file,
            "success": False,
            "error": str(e)
        }


async def crackmapexec_scan(
    target: str,
    protocol: str = "smb",
    username: str = "",
    password: str = "",
    hash: str = ""
) -> Dict[str, Any]:
    """
    Network service exploitation and post-exploitation with CrackMapExec.

    Args:
        target: Target IP or CIDR
        protocol: Protocol (smb, winrm, ssh, mssql, ldap)
        username: Username
        password: Password
        hash: NTLM hash

    Returns:
        Exploitation results
    """
    validator = get_validator()

    try:
        validator.validate_target(target)

        cmd = ["crackmapexec", protocol, target]

        if username:
            cmd.extend(["-u", username])

        if password:
            cmd.extend(["-p", password])
        elif hash:
            cmd.extend(["-H", hash])

        validator.log_tool_execution(
            "crackmapexec",
            target,
            {"protocol": protocol, "username": username}
        )

        result = await execute_command(cmd, timeout=600, tool_name="crackmapexec")

        return {
            "tool": "crackmapexec",
            "target": target,
            "protocol": protocol,
            "success": result["success"],
            "output": result["stdout"],
            "errors": result["stderr"],
            "duration_seconds": result["duration_seconds"]
        }

    except Exception as e:
        logger.error(f"CrackMapExec error: {e}")
        return {
            "tool": "crackmapexec",
            "target": target,
            "success": False,
            "error": str(e)
        }


def list_tools() -> List[types.Tool]:
    """List all exploitation tools."""
    return [
        types.Tool(
            name="hydra_bruteforce",
            description="Fast network login password brute-forcing tool.",
            inputSchema={
                "type": "object",
                "properties": {
                    "target": {
                        "type": "string",
                        "description": "Target IP or hostname"
                    },
                    "service": {
                        "type": "string",
                        "description": "Service to attack",
                        "default": "ssh"
                    },
                    "username": {
                        "type": "string",
                        "description": "Single username",
                        "default": ""
                    },
                    "username_list": {
                        "type": "string",
                        "description": "Username list path",
                        "default": ""
                    },
                    "password_list": {
                        "type": "string",
                        "description": "Password list path",
                        "default": "/usr/share/wordlists/rockyou.txt"
                    },
                    "port": {
                        "type": "integer",
                        "description": "Custom port",
                        "default": 0
                    }
                },
                "required": ["target"]
            }
        ),
        types.Tool(
            name="hashcat_crack",
            description="Advanced password hash cracking using GPU acceleration.",
            inputSchema={
                "type": "object",
                "properties": {
                    "hash_file": {
                        "type": "string",
                        "description": "File containing hashes"
                    },
                    "hash_type": {
                        "type": "integer",
                        "description": "Hash type (0=MD5, 1000=NTLM, 1800=SHA512)",
                        "default": 0
                    },
                    "wordlist": {
                        "type": "string",
                        "description": "Wordlist path",
                        "default": "/usr/share/wordlists/rockyou.txt"
                    },
                    "rules": {
                        "type": "string",
                        "description": "Rules file",
                        "default": ""
                    }
                },
                "required": ["hash_file"]
            }
        ),
        types.Tool(
            name="john_crack",
            description="Password cracking with John the Ripper.",
            inputSchema={
                "type": "object",
                "properties": {
                    "hash_file": {
                        "type": "string",
                        "description": "File containing hashes"
                    },
                    "format": {
                        "type": "string",
                        "description": "Hash format",
                        "default": ""
                    },
                    "wordlist": {
                        "type": "string",
                        "description": "Wordlist path",
                        "default": "/usr/share/wordlists/rockyou.txt"
                    }
                },
                "required": ["hash_file"]
            }
        ),
        types.Tool(
            name="crackmapexec_scan",
            description="Network service exploitation and post-exploitation framework.",
            inputSchema={
                "type": "object",
                "properties": {
                    "target": {
                        "type": "string",
                        "description": "Target IP or CIDR"
                    },
                    "protocol": {
                        "type": "string",
                        "description": "Protocol (smb, winrm, ssh, mssql, ldap)",
                        "default": "smb"
                    },
                    "username": {
                        "type": "string",
                        "description": "Username",
                        "default": ""
                    },
                    "password": {
                        "type": "string",
                        "description": "Password",
                        "default": ""
                    },
                    "hash": {
                        "type": "string",
                        "description": "NTLM hash",
                        "default": ""
                    }
                },
                "required": ["target"]
            }
        )
    ]


def get_tools() -> List[Dict[str, Any]]:
    """Get tool handlers for registration."""
    return [
        {"name": "hydra_bruteforce", "handler": hydra_bruteforce},
        {"name": "hashcat_crack", "handler": hashcat_crack},
        {"name": "john_crack", "handler": john_crack},
        {"name": "crackmapexec_scan", "handler": crackmapexec_scan},
    ]
